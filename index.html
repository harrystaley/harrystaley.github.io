<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Security Shepherd - Insecure Cryptographic Storage Challenge 2</title>
	<link href="https://security.codepath.com/css/lessonCss/theCss.css" rel="stylesheet" type="text/css" media="screen" />
	
</head>
<body>
	<script type="text/javascript" src="https://security.codepath.com/js/jquery.js"></script>
	<script type="text/javascript" src="https://security.codepath.com/js/clipboard-js/clipboard.min.js"></script>
	<script type="text/javascript" src="https://security.codepath.com/js/clipboard-js/tooltips.js"></script>
	<script type="text/javascript" src="https://security.codepath.com/js/clipboard-js/clipboard-events.js"></script>
		<div id="contentDiv">
			<h2 class="title">Insecure Cryptographic Storage Challenge 2</h2>
			<p> 
				The result key has been encrypted to ensure that nobody can finish the challenge without knowing the secret key to decrypt it. The following form can be used to check if you have the correct result key.
				<br/>
				<br/>
				<form id="leForm" action="javascript:;">
				<table>
					<tr><td>
						<input type="text" id="resultKeyAttempt" style="width: 300px;"/></><input type="submit" value="Check Result Key"/>
					</td></tr>
				</table>
				</form>
				<br/>
				<br/>
				<div id="resultDiv"></div>
			</p>
		</div>
		<script>			
		$("#leForm").submit(function(){
			// 2D Encryption
			var input = $("#resultKeyAttempt").val();
			theKey = "kpoisaijdieyjaf";
			var theAlphabet =   "ABCDEFGHIJKLMNOPQRSTUVWXYZ" + "abcdefghijklmnopqrstuvwxyz";

			// Validate theKey:
			theKey = theKey.toUpperCase();
			var theKeysLength = theKey.length;
			var i;
			var adjustedKey = "";
			for(i = 0; i < theKeysLength; i ++)
			{
				var currentKeyChar = theAlphabet.indexOf(theKey.charAt(i));
				if(currentKeyChar < 0)
					continue;
				adjustedKey += theAlphabet.charAt(currentKeyChar);
			}
			theKey = adjustedKey;
			theKeysLength = theKey.length;

			// Transform input:
			var inputLength = input.length;
			var output = "";
			var theKeysCurrentIndex = 0;
			for(i = 0; i < inputLength; i ++)
			{
				var currentChar = input.charAt(i);
				var currentCharValue = theAlphabet.indexOf(currentChar);
				if(currentCharValue < 0)
				{
					output += currentChar;
					continue;
				}
				var lowercase = currentCharValue >= 26 ? true : false;
				currentCharValue -= theAlphabet.indexOf(theKey.charAt(theKeysCurrentIndex));
				currentCharValue += 26;
				if(lowercase)
					currentCharValue = currentCharValue % 26 + 26;
				else
					currentCharValue %= 26;
				output += theAlphabet.charAt(currentCharValue);
				theKeysCurrentIndex =(theKeysCurrentIndex + 1) % theKeysLength;
			}
			/*
			// Check result for validity
			$("#resultDiv").hide("fast", function(){
				if(output == "DwsDagmwhziArpmogWaSmmckwhMoEsmgmxlivpDttfjbjdxqBwxbKbCwgwgUyam")
					$('#resultDiv').html("<p>Yeah, that's correct</p>");
				else
					$('#resultDiv').html("<p>No, that's not correct</p>");
				$("#resultDiv").show("slow");
			});
			*/
			// Output the "output" variable to the HTML for viewing
			
			$("#resultDiv").hide("fast", function(){
					$('#resultDiv').html("<p> Encrypted Output: " + output + "<p>");
				$("#resultDiv").show("slow");
			});
			
		});
		</script>
		
</body>
</html>

